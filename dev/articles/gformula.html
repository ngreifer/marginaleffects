<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="marginaleffects">
<title>Causal Inference with the Parametric g-Formula • marginaleffects</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Causal Inference with the Parametric g-Formula">
<meta property="og:description" content="marginaleffects">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">marginaleffects</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.8.1.9125</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/marginaleffects.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/vincentarelbundock/marginaleffects/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Causal Inference with the Parametric g-Formula</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/vincentarelbundock/marginaleffects/blob/HEAD/vignettes/gformula.Rmd" class="external-link"><code>vignettes/gformula.Rmd</code></a></small>
      <div class="d-none name"><code>gformula.Rmd</code></div>
    </div>

    
    
<p>This vignette has 3 goals:</p>
<ol style="list-style-type: decimal">
<li>Give a <em>concise</em> introduction to the idea of “Parametric
g-Formula”</li>
<li>Highlight the equivalence between one form of g-estimation and the
<a href="https://vincentarelbundock.github.io/marginaleffects/articles/comparisons.html#average-contrasts">“Average
Contrasts”</a> computed by <code>marginaleffects</code>
</li>
<li>Show how to obtain estimates, standard errors, and confidence
intervals via the Parametric g-Formula, using a single line of
<code>marginaleffects</code> code. This is convenient because,
typically, analysts have to construct counterfactual datasets manually
and must bootstrap their estimates.</li>
</ol>
<p>The “Parametric g-Formula” is often used for causal inference in
observational data.</p>
<p>The explanations and illustrations that follow draw heavily on
Chapter 13 of this excellent book <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/" class="external-link">(free
copy available online)</a>:</p>
<blockquote>
<p>Hernán MA, Robins JM (2020). Causal Inference: What If. Boca Raton:
Chapman &amp; Hall/CRC.</p>
</blockquote>
<div class="section level2">
<h2 id="what-is-the-parametric-g-formula">What is the parametric g-formula?<a class="anchor" aria-label="anchor" href="#what-is-the-parametric-g-formula"></a>
</h2>
<p>The parametric g-formula is a method of standardization which can be
used to address confounding problems in causal inference with
observational data. It relies on the same identification assumptions as
Inverse Probability Weighting (IPW), but uses different modeling
assumptions. Whereas IPW models the treatment equation, standardization
models the mean outcome equation. As Hernán and Robins note:</p>
<blockquote>
<p>“Both IP weighting and standardization are estimators of the
g-formula, a general method for causal inference first described in
1986. … We say that standardization is a”plug-in g-formula estimator”
because it simply replaces the conditional mean outcome in the g-formula
by its estimates. When, like in Chapter 13, those estimates come from
parametric models, we refer to the method as the parametric
g-formula.”</p>
</blockquote>
</div>
<div class="section level2">
<h2 id="how-does-it-work">How does it work?<a class="anchor" aria-label="anchor" href="#how-does-it-work"></a>
</h2>
<p>Imagine a causal model like this:</p>
<p><img src="gformula_files/figure-html/unnamed-chunk-1-1.png" width="40%"></p>
<p>We want to estimate the effect of a binary treatment <span class="math inline">\(X\)</span> on outcome <span class="math inline">\(Y\)</span>, but there is a confounding variable
<span class="math inline">\(W\)</span>. We can use standardization with
the parametric g-formula to handle this. Roughly speaking, the procedure
is as follows:</p>
<ol style="list-style-type: decimal">
<li>Use the observed data to fit a regression model with <span class="math inline">\(Y\)</span> as outcome, <span class="math inline">\(X\)</span> as treatment, and <span class="math inline">\(W\)</span> as control variable (with perhaps some
polynomials and/or interactions if there are multiple control
variables).</li>
<li>Create a new dataset exactly identical to the original data, but
where <span class="math inline">\(X=1\)</span> in every row.</li>
<li>Create a new dataset exactly identical to the original data, but
where <span class="math inline">\(X=0\)</span> in every row.</li>
<li>Use the model from Step 1 to compute adjusted predictions in the two
counterfactual datasets from Steps 2 and 3.</li>
<li>The quantity of interest is the difference between the means of
adjusted predictions in the two counterfactual datasets.</li>
</ol>
<p>This is equivalent to computing an <a href="https://vincentarelbundock.github.io/marginaleffects/articles/comparisons.html#average-contrasts">“Average
Contrast”</a>, in which the value of <span class="math inline">\(X\)</span> moves from 0 to 1. Thanks to this
equivalence, we can apply the parametric g-formula method using a single
line of code in <code>marginaleffects</code>, and obtain delta method
standard errors automatically.</p>
</div>
<div class="section level2">
<h2 id="example-with-real-world-data">Example with real-world data<a class="anchor" aria-label="anchor" href="#example-with-real-world-data"></a>
</h2>
<p>Let’s illustrate this method by replicating an example from Chapter
13 of Hernán and Robins. The data come from the National Health and
Nutrition Examination Survey Data I Epidemiologic Follow-up Study
(NHEFS). The outcome is <code>wt82_71</code>, a measure of weight gain.
The treatment is <code>qsmk</code>, a binary measure of smoking
cessation. There are many confounders.</p>
<p>Step 1 is to fit a regression model of the outcome on the treatment
and control variables:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">f</span> <span class="op">&lt;-</span> <span class="va">wt82_71</span> <span class="op">~</span> <span class="va">qsmk</span> <span class="op">+</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">age</span> <span class="op">*</span> <span class="va">age</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">education</span><span class="op">)</span> <span class="op">+</span></span>
<span>     <span class="va">smokeintensity</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">smokeintensity</span> <span class="op">*</span> <span class="va">smokeintensity</span><span class="op">)</span> <span class="op">+</span> <span class="va">smokeyrs</span> <span class="op">+</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">smokeyrs</span> <span class="op">*</span> <span class="va">smokeyrs</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">exercise</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">active</span><span class="op">)</span> <span class="op">+</span> <span class="va">wt71</span> <span class="op">+</span></span>
<span>     <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">wt71</span> <span class="op">*</span> <span class="va">wt71</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">qsmk</span> <span class="op">*</span> <span class="va">smokeintensity</span><span class="op">)</span></span>
<span></span>
<span><span class="va">url</span> <span class="op">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/vincentarelbundock/modelarchive/main/data-raw/nhefs.csv"</span></span>
<span><span class="va">nhefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">url</span><span class="op">)</span></span>
<span><span class="va">nhefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">nhefs</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/allnames.html" class="external-link">all.vars</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="va">nhefs</span><span class="op">)</span></span></code></pre></div>
<p>Steps 2 and 3 require us to replicate the full dataset by setting the
<code>qsmk</code> treatment to counterfactual values. We can do this
automatically by calling <code><a href="../reference/comparisons.html">comparisons()</a></code>.</p>
<div class="section level3">
<h3 id="tldr">TLDR<a class="anchor" aria-label="anchor" href="#tldr"></a>
</h3>
<p>These simple commands do everything we need to apply the parametric
g-formula:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>qsmk <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  qsmk    1 - 0    3.517     0.4403 7.989 1.3613e-15 2.654   4.38</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Prediction type:  response </span></span>
<span><span class="co">## Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre>
<p>The rest of the vignette walks through the process in a bit more
detail and compares to replication code from Hernán and Robins.</p>
</div>
<div class="section level3">
<h3 id="adjusted-predictions">Adjusted Predictions<a class="anchor" aria-label="anchor" href="#adjusted-predictions"></a>
</h3>
<p>We can compute average predictions in the original data, and average
predictions in the two counterfactual datasets like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># average predicted outcome in the original data</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.6383</span></span></code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># average predicted outcome in the two counterfactual datasets</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>qsmk <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">estimate</span> <span class="op">~</span> <span class="va">qsmk</span>, data <span class="op">=</span> <span class="va">p</span>, FUN <span class="op">=</span> <span class="va">mean</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   qsmk estimate</span></span>
<span><span class="co">## 1    0 1.756213</span></span>
<span><span class="co">## 2    1 5.273587</span></span></code></pre>
<p>In the <code>R</code> code that accompanies their book, Hernán and
Robins compute the same quantities manually, as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create a dataset with 3 copies of each subject</span></span>
<span><span class="va">nhefs</span><span class="op">$</span><span class="va">interv</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span> <span class="co"># 1st copy: equal to original one</span></span>
<span></span>
<span><span class="va">interv0</span> <span class="op">&lt;-</span> <span class="va">nhefs</span> <span class="co"># 2nd copy: treatment set to 0, outcome to missing</span></span>
<span><span class="va">interv0</span><span class="op">$</span><span class="va">interv</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">interv0</span><span class="op">$</span><span class="va">qsmk</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">interv0</span><span class="op">$</span><span class="va">wt82_71</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="va">interv1</span> <span class="op">&lt;-</span> <span class="va">nhefs</span> <span class="co"># 3rd copy: treatment set to 1, outcome to missing</span></span>
<span><span class="va">interv1</span><span class="op">$</span><span class="va">interv</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">interv1</span><span class="op">$</span><span class="va">qsmk</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">interv1</span><span class="op">$</span><span class="va">wt82_71</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="va">onesample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">nhefs</span>, <span class="va">interv0</span>, <span class="va">interv1</span><span class="op">)</span> <span class="co"># combining datasets</span></span>
<span></span>
<span><span class="co"># linear model to estimate mean outcome conditional on treatment and confounders</span></span>
<span><span class="co"># parameters are estimated using original observations only (nhefs)</span></span>
<span><span class="co"># parameter estimates are used to predict mean outcome for observations with </span></span>
<span><span class="co"># treatment set to 0 (interv=0) and to 1 (interv=1)</span></span>
<span></span>
<span><span class="va">std</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="va">onesample</span><span class="op">)</span></span>
<span><span class="va">onesample</span><span class="op">$</span><span class="va">predicted_meanY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">std</span>, <span class="va">onesample</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># estimate mean outcome in each of the groups interv=0, and interv=1</span></span>
<span><span class="co"># this mean outcome is a weighted average of the mean outcomes in each combination </span></span>
<span><span class="co"># of values of treatment and confounders, that is, the standardized outcome</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">$</span><span class="va">interv</span> <span class="op">==</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>, <span class="op">]</span><span class="op">$</span><span class="va">predicted_meanY</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.6383</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">$</span><span class="va">interv</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, <span class="op">]</span><span class="op">$</span><span class="va">predicted_meanY</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1.756213</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">$</span><span class="va">interv</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="op">]</span><span class="op">$</span><span class="va">predicted_meanY</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 5.273587</span></span></code></pre>
<p>It may be useful to note that the <code><a href="../reference/datagrid.html">datagrid()</a></code> function
provided by <code>marginaleffects</code> can create counterfactual
datasets automatically. This is equivalent to the <code>onesample</code>
dataset:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span></span>
<span>    model <span class="op">=</span> <span class="va">fit</span>,</span>
<span>    qsmk <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="contrast">Contrast<a class="anchor" aria-label="anchor" href="#contrast"></a>
</h3>
<p>Now we want to compute the treatment effect with the parametric
g-formula, which is the difference in average predicted outcomes in the
two counterfactual datasets. This is equivalent to taking the average
contrast with the <code><a href="../reference/comparisons.html">comparisons()</a></code> function. There are three
important things to note in the command that follows:</p>
<ul>
<li>The <code>variables</code> argument is used to indicate that we want
to estimate a “contrast” between adjusted predictions when
<code>qsmk</code> is equal to 1 or 0.</li>
<li>
<code><a href="../reference/comparisons.html">comparisons()</a></code> automatically produces estimates of
uncertainty.</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">std</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>qsmk <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  qsmk    1 - 0    3.517     0.4403 7.989 1.3613e-15 2.654   4.38</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Prediction type:  response </span></span>
<span><span class="co">## Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre>
<p>Under the hood, <code><a href="../reference/comparisons.html">comparisons()</a></code> did exactly what we
described in the g-formula steps above:</p>
<p>We can obtain the same result by manually computing the quantities,
using the replication code from Hernán and Robins:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">$</span><span class="va">interv</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, <span class="op">]</span><span class="op">$</span><span class="va">predicted_meanY</span><span class="op">)</span> <span class="op">-</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">onesample</span><span class="op">$</span><span class="va">interv</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>, <span class="op">]</span><span class="op">$</span><span class="va">predicted_meanY</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3.517374</span></span></code></pre>
<p>Although manual computation is simple, it does not provide
uncertainty estimates. In contrast, <code><a href="../reference/comparisons.html">comparisons()</a></code> has
already computed the standard error and confidence interval using the
delta method.</p>
<p>Instead of the delta method, most analysts will rely on
bootstrapping. For example, the replication code from Hernán and Robins
does this:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># function to calculate difference in means</span></span>
<span><span class="va">standardization</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">indices</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># create a dataset with 3 copies of each subject</span></span>
<span>    <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span> <span class="co"># 1st copy: equal to original one`</span></span>
<span>    <span class="va">d</span><span class="op">$</span><span class="va">interv</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1</span></span>
<span>    <span class="va">d0</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="co"># 2nd copy: treatment set to 0, outcome to missing</span></span>
<span>    <span class="va">d0</span><span class="op">$</span><span class="va">interv</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="va">d0</span><span class="op">$</span><span class="va">qsmk</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="va">d0</span><span class="op">$</span><span class="va">wt82_71</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="va">d1</span> <span class="op">&lt;-</span> <span class="va">d</span> <span class="co"># 3rd copy: treatment set to 1, outcome to missing</span></span>
<span>    <span class="va">d1</span><span class="op">$</span><span class="va">interv</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">d1</span><span class="op">$</span><span class="va">qsmk</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>    <span class="va">d1</span><span class="op">$</span><span class="va">wt82_71</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="va">d.onesample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">d0</span>, <span class="va">d1</span><span class="op">)</span> <span class="co"># combining datasets</span></span>
<span></span>
<span>    <span class="co"># linear model to estimate mean outcome conditional on treatment and confounders</span></span>
<span>    <span class="co"># parameters are estimated using original observations only (interv= -1)</span></span>
<span>    <span class="co"># parameter estimates are used to predict mean outcome for observations with set</span></span>
<span>    <span class="co"># treatment (interv=0 and interv=1)</span></span>
<span>    <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">f</span>, data <span class="op">=</span> <span class="va">d.onesample</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">d.onesample</span><span class="op">$</span><span class="va">predicted_meanY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">d.onesample</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># estimate mean outcome in each of the groups interv=-1, interv=0, and interv=1</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">d.onesample</span><span class="op">$</span><span class="va">predicted_meanY</span><span class="op">[</span><span class="va">d.onesample</span><span class="op">$</span><span class="va">interv</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">-</span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">d.onesample</span><span class="op">$</span><span class="va">predicted_meanY</span><span class="op">[</span><span class="va">d.onesample</span><span class="op">$</span><span class="va">interv</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># bootstrap</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nhefs</span>, statistic <span class="op">=</span> <span class="va">standardization</span>, R <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generating confidence intervals</span></span>
<span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">results</span><span class="op">$</span><span class="va">t</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">meant0</span> <span class="op">&lt;-</span> <span class="va">results</span><span class="op">$</span><span class="va">t0</span></span>
<span><span class="va">ll</span> <span class="op">&lt;-</span> <span class="va">meant0</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span> <span class="op">*</span> <span class="va">se</span></span>
<span><span class="va">ul</span> <span class="op">&lt;-</span> <span class="va">meant0</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span> <span class="op">*</span> <span class="va">se</span></span>
<span></span>
<span><span class="va">bootstrap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    <span class="st">" "</span> <span class="op">=</span> <span class="st">"Treatment - No Treatment"</span>,</span>
<span>    estimate <span class="op">=</span> <span class="va">meant0</span>,</span>
<span>    std.error <span class="op">=</span> <span class="va">se</span>,</span>
<span>    conf.low <span class="op">=</span> <span class="va">ll</span>,</span>
<span>    conf.high <span class="op">=</span> <span class="va">ul</span>,</span>
<span>    check.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">bootstrap</span></span></code></pre></div>
<pre><code><span><span class="co">##                            estimate std.error conf.low conf.high</span></span>
<span><span class="co">## 1 Treatment - No Treatment 3.517374 0.4720851 2.592104  4.442644</span></span></code></pre>
<p>The results are close to those that we obtained with
<code><a href="../reference/comparisons.html">comparisons()</a></code>, but the confidence interval differs slightly
because of the difference between bootstrapping and the delta
method.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>qsmk <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  qsmk    1 - 0    3.517     0.4403 7.989 1.3613e-15 2.654   4.38</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Prediction type:  response </span></span>
<span><span class="co">## Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Vincent Arel-Bundock.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
