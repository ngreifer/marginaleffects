<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="marginaleffects">
<title>Comparisons • marginaleffects</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Comparisons">
<meta property="og:description" content="marginaleffects">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">marginaleffects</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.8.1.9125</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/marginaleffects.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item">
  <a class="nav-link" href="../articles/index.html">Articles</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/vincentarelbundock/marginaleffects/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Comparisons</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/vincentarelbundock/marginaleffects/blob/HEAD/vignettes/comparisons.Rmd" class="external-link"><code>vignettes/comparisons.Rmd</code></a></small>
      <div class="d-none name"><code>comparisons.Rmd</code></div>
    </div>

    
    
<p><a href="https://vincentarelbundock.github.io/marginaleffects/articles/slopes.html">In
another vignette</a>, we introduced the “marginal effect” as a partial
derivative. Since derivatives are only properly defined for continuous
variables, we cannot use them to interpret the effects of changes in
categorical variables. For this, we turn to <em>contrasts</em> between
<a href="https://vincentarelbundock.github.io/marginaleffects/articles/predictions.html">Adjusted
predictions.</a> In the context of this package, a “Contrast” is defined
as:</p>
<blockquote>
<p>A difference, ratio, or function of adjusted predictions, calculated
for meaningfully different predictor values (e.g., College graduates
vs. Others).</p>
</blockquote>
<p>The <code><a href="../reference/slopes.html">slopes()</a></code> function automatically calculates contrasts
instead of derivatives for factor, logical, or character variables.</p>
<p>The <code><a href="../reference/comparisons.html">comparisons()</a></code> function gives users more powerful
features to compute different contrasts, such as differences, risk
ratios, linear combinations, and transformations.</p>
<div class="section level2">
<h2 id="simple-example-titanic">Simple example: Titanic<a class="anchor" aria-label="anchor" href="#simple-example-titanic"></a>
</h2>
<p>Consider a logistic regression model estimated using the Titanic
mortality data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/Stat2Data/Titanic.csv"</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Survived</span> <span class="op">~</span> <span class="va">PClass</span> <span class="op">*</span> <span class="va">SexCode</span> <span class="op">*</span> <span class="va">Age</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></code></pre></div>
<p>The question that interests us is:</p>
<blockquote>
<p>How does the probability of survival (outcome) change if a passenger
travels in 1st class vs. 3rd class?</p>
</blockquote>
<p>The answer to that question is not straightforward because, in
non-linear models with interactions, the effect of a change in one
variable depends on the values of all the other covariates in the model.
Therefore, we need to refine the question:</p>
<blockquote>
<p>How does the probability of survival (outcome) change if a 25 year
old man travels in 1st class vs. 3rd class?</p>
</blockquote>
<p>Here, the <em>estimand</em> is the difference in probabilities for
<code>PClass="1st"</code> and <code>PClass="3rd"</code>, and this
estimand is conditional on the values of the covariates
<code>Age=25</code> and <code>SexCode=1</code>. In the
<code><a href="../reference/comparisons.html">comparisons()</a></code> function, the <code>variables</code> argument
determines the scientific query (estimand or comparison), and the
<code>newdata</code> argument determines <em>where</em> we estimate this
query (conditional on what covariate values). For example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"3rd"</span>, <span class="st">"1st"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>Age <span class="op">=</span> <span class="fl">25</span>, SexCode <span class="op">=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    Term  Contrast Estimate Std. Error    z   Pr(&gt;|z|) 2.5 % 97.5 % Age SexCode</span></span>
<span><span class="co">#&gt;  PClass 1st - 3rd   0.3918    0.07491 5.23 1.6947e-07 0.245 0.5386  25       0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: rowid, type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, Survived, PClass, Age, SexCode</span></span></code></pre></div>
<p>We can compute the same contrast for different “kinds” of
individuals, by changing the <code><a href="../reference/datagrid.html">datagrid()</a></code> call. This function
accepts functions or vectors. Here, we compute the contrast between the
probabilities of survival in 1st and 3rd class for the oldest men and
women passengers:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"3rd"</span>, <span class="st">"1st"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>Age <span class="op">=</span> <span class="va">range</span>, SexCode <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    Term  Contrast Estimate Std. Error     z   Pr(&gt;|z|)    2.5 % 97.5 %   Age SexCode</span></span>
<span><span class="co">#&gt;  PClass 1st - 3rd  0.44260    0.14818 2.987 0.00281726  0.15218 0.7330  0.17       0</span></span>
<span><span class="co">#&gt;  PClass 1st - 3rd  0.47018    0.13297 3.536 0.00040642  0.20956 0.7308  0.17       1</span></span>
<span><span class="co">#&gt;  PClass 1st - 3rd  0.07107    0.04533 1.568 0.11690206 -0.01777 0.1599 71.00       0</span></span>
<span><span class="co">#&gt;  PClass 1st - 3rd  0.52411    0.20599 2.544 0.01094812  0.12038 0.9278 71.00       1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: rowid, type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, Survived, PClass, Age, SexCode</span></span></code></pre></div>
<p>If we do <em>not</em> specify the <code>newdata</code> argument, then
<code><a href="../reference/comparisons.html">comparisons()</a></code> will calculate the contrast for every single
combination of covariate values in the original data. This means that we
will obtain a data frame of results with the same number of rows as the
original data. This makes sense, because in non-linear models or in
models with interactions, each individual can have a different
contrast:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"3rd"</span>, <span class="st">"1st"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># number of contrast estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cmp</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 756</span></span>
<span></span>
<span><span class="co"># number of observations in the model</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/nobs.html" class="external-link">nobs</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 756</span></span></code></pre></div>
<p>A big dataset of contrasts like this one can be unwieldy. A common
strategy is to summarize the unit-level contrasts by taking their
average. This can be achieved using the <code><a href="../reference/comparisons.html">avg_comparisons()</a></code>
function or the <code>by</code> argument:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, by <span class="op">=</span> <span class="st">"PClass"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term              Contrast PClass  Estimate Std. Error      z   Pr(&gt;|z|)     2.5 %    97.5 %</span></span>
<span><span class="co">#&gt;   PClass mean(2nd) - mean(1st)    1st -0.200686   0.036485 -5.500 3.7873e-08 -0.272195 -0.129176</span></span>
<span><span class="co">#&gt;   PClass mean(2nd) - mean(1st)    2nd -0.217672   0.041560 -5.238 1.6276e-07 -0.299128 -0.136215</span></span>
<span><span class="co">#&gt;   PClass mean(2nd) - mean(1st)    3rd -0.246775   0.050681 -4.869 1.1207e-06 -0.346108 -0.147442</span></span>
<span><span class="co">#&gt;   PClass mean(3rd) - mean(1st)    1st -0.367209   0.044051 -8.336 &lt; 2.22e-16 -0.453548 -0.280871</span></span>
<span><span class="co">#&gt;   PClass mean(3rd) - mean(1st)    2nd -0.406367   0.043521 -9.337 &lt; 2.22e-16 -0.491667 -0.321068</span></span>
<span><span class="co">#&gt;   PClass mean(3rd) - mean(1st)    3rd -0.408779   0.049654 -8.233 &lt; 2.22e-16 -0.506099 -0.311459</span></span>
<span><span class="co">#&gt;  SexCode     mean(1) - mean(0)    1st  0.589466   0.045990 12.817 &lt; 2.22e-16  0.499327  0.679606</span></span>
<span><span class="co">#&gt;  SexCode     mean(1) - mean(0)    2nd  0.704701   0.045534 15.476 &lt; 2.22e-16  0.615456  0.793946</span></span>
<span><span class="co">#&gt;  SexCode     mean(1) - mean(0)    3rd  0.293547   0.056171  5.226 1.7325e-07  0.183454  0.403639</span></span>
<span><span class="co">#&gt;      Age              mean(+1)    1st -0.005706   0.001476 -3.865 0.00011097 -0.008599 -0.002813</span></span>
<span><span class="co">#&gt;      Age              mean(+1)    2nd -0.009270   0.001734 -5.346 8.9948e-08 -0.012669 -0.005871</span></span>
<span><span class="co">#&gt;      Age              mean(+1)    3rd -0.004256   0.002113 -2.014 0.04401973 -0.008399 -0.000114</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, PClass, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"SexCode"</span>, by <span class="op">=</span> <span class="st">"PClass"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term          Contrast PClass Estimate Std. Error      z   Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  SexCode mean(1) - mean(0)    1st   0.5895    0.04599 12.817 &lt; 2.22e-16 0.4993 0.6796</span></span>
<span><span class="co">#&gt;  SexCode mean(1) - mean(0)    2nd   0.7047    0.04553 15.476 &lt; 2.22e-16 0.6155 0.7939</span></span>
<span><span class="co">#&gt;  SexCode mean(1) - mean(0)    3rd   0.2935    0.05617  5.226 1.7325e-07 0.1835 0.4036</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, PClass, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code></pre></div>
<p>Note that average contrasts often have a nice interpretation in a
causal inference context, as the outcome of parametric g-formula
estimation. See this vignette: <a href="https://vincentarelbundock.github.io/marginaleffects/articles/gformula.html" class="uri">https://vincentarelbundock.github.io/marginaleffects/articles/gformula.html</a></p>
<p>The rest of this vignette highlights some of the other features of
the very flexible and powerful <code><a href="../reference/comparisons.html">comparisons()</a></code> function.</p>
</div>
<div class="section level2">
<h2 id="predictor-types">Predictor types<a class="anchor" aria-label="anchor" href="#predictor-types"></a>
</h2>
<div class="section level3">
<h3 id="logical-and-factor-predictors">Logical and factor predictors<a class="anchor" aria-label="anchor" href="#logical-and-factor-predictors"></a>
</h3>
<p>Consider a simple model with a logical and a factor variable:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="va">mtcars</span></span>
<span><span class="va">tmp</span><span class="op">$</span><span class="va">am</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">am</span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">am</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span>, <span class="va">tmp</span><span class="op">)</span></span></code></pre></div>
<p>The <code>comparisons</code> function automatically computes
contrasts for each level of the categorical variables, relative to the
baseline category (<code>FALSE</code> for logicals, and the reference
level for factors), while holding all other values at their observed
values. The <code><a href="../reference/comparisons.html">avg_comparisons()</a></code> does the same, but then
marginalizes by taking the average of unit-level estimates:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="va">cmp</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term     Contrast Estimate Std. Error      z   Pr(&gt;|z|)     2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;    am TRUE - FALSE    2.560      1.298  1.973    0.04851   0.01675  5.103</span></span>
<span><span class="co">#&gt;   cyl        6 - 4   -6.156      1.536 -4.009 6.1077e-05  -9.16608 -3.146</span></span>
<span><span class="co">#&gt;   cyl        8 - 4  -10.068      1.452 -6.933 4.1146e-12 -12.91359 -7.222</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>The summary printed above says that moving from the reference
category <code>4</code> to the level <code>6</code> on the
<code>cyl</code> factor variable is associated with a change of -6.156
in the adjusted prediction. Similarly, the contrast from
<code>FALSE</code> to <code>TRUE</code> on the <code>am</code> variable
is equal to 2.560.</p>
<p>We can obtain different contrasts by using the
<code><a href="../reference/comparisons.html">comparisons()</a></code> function. For example:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="st">"sequential"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error      z   Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   cyl    6 - 4   -6.156      1.536 -4.009 6.1077e-05 -9.166 -3.146</span></span>
<span><span class="co">#&gt;   cyl    8 - 6   -3.911      1.470 -2.660  0.0078051 -6.793 -1.030</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="st">"pairwise"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error      z   Pr(&gt;|z|)   2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   cyl    6 - 4   -6.156      1.536 -4.009 6.1077e-05  -9.166 -3.146</span></span>
<span><span class="co">#&gt;   cyl    8 - 4  -10.068      1.452 -6.933 4.1146e-12 -12.914 -7.222</span></span>
<span><span class="co">#&gt;   cyl    8 - 6   -3.911      1.470 -2.660  0.0078051  -6.793 -1.030</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cyl <span class="op">=</span> <span class="st">"reference"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error      z   Pr(&gt;|z|)   2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   cyl    6 - 4   -6.156      1.536 -4.009 6.1077e-05  -9.166 -3.146</span></span>
<span><span class="co">#&gt;   cyl    8 - 4  -10.068      1.452 -6.933 4.1146e-12 -12.914 -7.222</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>For comparison, this code produces the same results using the
<code>emmeans</code> package:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rvlenth/emmeans" class="external-link">emmeans</a></span><span class="op">)</span></span>
<span><span class="va">emm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">mod</span>, specs <span class="op">=</span> <span class="st">"cyl"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/contrast.html" class="external-link">contrast</a></span><span class="op">(</span><span class="va">emm</span>, method <span class="op">=</span> <span class="st">"revpairwise"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  contrast    estimate   SE df t.ratio p.value</span></span>
<span><span class="co">#&gt;  cyl6 - cyl4    -6.16 1.54 28  -4.009  0.0012</span></span>
<span><span class="co">#&gt;  cyl8 - cyl4   -10.07 1.45 28  -6.933  &lt;.0001</span></span>
<span><span class="co">#&gt;  cyl8 - cyl6    -3.91 1.47 28  -2.660  0.0331</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results are averaged over the levels of: am </span></span>
<span><span class="co">#&gt; P value adjustment: tukey method for comparing a family of 3 estimates</span></span>
<span></span>
<span><span class="va">emm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">mod</span>, specs <span class="op">=</span> <span class="st">"am"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/contrast.html" class="external-link">contrast</a></span><span class="op">(</span><span class="va">emm</span>, method <span class="op">=</span> <span class="st">"revpairwise"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  contrast     estimate  SE df t.ratio p.value</span></span>
<span><span class="co">#&gt;  TRUE - FALSE     2.56 1.3 28   1.973  0.0585</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results are averaged over the levels of: cyl</span></span></code></pre></div>
<p>Note that these commands also work on for other types of models, such
as GLMs, on different scales:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_logit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">am</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gear</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mtcars</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod_logit</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error         z   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  gear    4 - 3   0.6667  1.361e-01     4.899 9.6296e-07   0.4 0.9334</span></span>
<span><span class="co">#&gt;  gear    5 - 3   1.0000  1.071e-05 93335.529 &lt; 2.22e-16   1.0 1.0000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod_logit</span>, type <span class="op">=</span> <span class="st">"link"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error        z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  gear    4 - 3    21.26       4578 0.004644  0.99629  -8951   8994</span></span>
<span><span class="co">#&gt;  gear    5 - 3    41.13       9156 0.004492  0.99642 -17904  17986</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  link </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="character-predictors">Character predictors<a class="anchor" aria-label="anchor" href="#character-predictors"></a>
</h3>
<p>All functions of the <code>marginaleffects</code> package attempt to
treat character predictors as factor predictors. However, using factors
instead of characters when modeling is <em>strongly</em> encouraged,
because they are much safer and faster. This is because factors hold
useful information about the full list of levels, which makes them
easier to track and handle internally by <code>marginaleffects</code>.
Users are strongly encouraged to convert their character variables to
factor before fitting their models and using <code>slopes</code>
functions.</p>
</div>
<div class="section level3">
<h3 id="numeric-predictors">Numeric predictors<a class="anchor" aria-label="anchor" href="#numeric-predictors"></a>
</h3>
<p>We can also compute contrasts for differences in numeric variables.
For example, we can see what happens to the adjusted predictions when we
increment the <code>hp</code> variable by 1 unit (default) or by 5
units:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error      z  Pr(&gt;|z|)    2.5 %   97.5 %</span></span>
<span><span class="co">#&gt;    hp       +1 -0.06823    0.01012 -6.742 1.558e-11 -0.08806 -0.04839</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hp <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error      z  Pr(&gt;|z|)   2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;    hp       +5  -0.3411     0.0506 -6.742 1.558e-11 -0.4403 -0.242</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Compare adjusted predictions for a change in the regressor between
two arbitrary values:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">90</span>, <span class="fl">110</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error      z  Pr(&gt;|z|)  2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;    hp 110 - 90   -1.365     0.2024 -6.742 1.558e-11 -1.761 -0.9679</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Compare adjusted predictions when the regressor changes across the
interquartile range, across one or two standard deviations about its
mean, or from across its full range:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hp <span class="op">=</span> <span class="st">"iqr"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error      z  Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;    hp  Q3 - Q1   -5.697      0.845 -6.742 1.558e-11 -7.353 -4.041</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hp <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term                Contrast Estimate Std. Error      z  Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;    hp (x + sd/2) - (x - sd/2)   -4.678     0.6938 -6.742 1.558e-11 -6.038 -3.318</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hp <span class="op">=</span> <span class="st">"2sd"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term            Contrast Estimate Std. Error      z  Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;    hp (x - sd) - (x + sd)   -9.356      1.388 -6.742 1.558e-11 -12.08 -6.636</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hp <span class="op">=</span> <span class="st">"minmax"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term  Contrast Estimate Std. Error      z  Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;    hp Max - Min   -19.31      2.864 -6.742 1.558e-11 -24.92  -13.7</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="interactions">Interactions<a class="anchor" aria-label="anchor" href="#interactions"></a>
</h2>
<p>In some contexts we would like to know what happens when two (or
more) predictors change at the same time. In the
<code>marginaleffects</code> package terminology, this is an
“interaction between contrasts.”</p>
<p>For example, consider a model with two factor variables:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">am</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span></code></pre></div>
<p>What happens if <code>am</code> increases by 1 unit and
<code>cyl</code> changes from a baseline reference to another level?</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"am"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error      z  Pr(&gt;|z|)    2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   cyl    6 - 4   -5.292      1.608 -3.290 0.0010004  -8.4437 -2.140</span></span>
<span><span class="co">#&gt;   cyl    8 - 4   -9.810      1.516 -6.470   9.8e-11 -12.7820 -6.838</span></span>
<span><span class="co">#&gt;    am    1 - 0    2.247      1.335  1.684 0.0921982  -0.3684  4.863</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>When the <code>variables</code> argument is used and the model
formula includes interactions, the “cross-contrasts” will automatically
be displayed. You can also force <code><a href="../reference/comparisons.html">comparisons()</a></code> to do it by
setting <code>interactions=TRUE</code> and using the
<code>variables</code> argument to specify which variables should be
manipulated simultaneously.</p>
</div>
<div class="section level2">
<h2 id="quantities-of-interest">Quantities of interest<a class="anchor" aria-label="anchor" href="#quantities-of-interest"></a>
</h2>
<p>This section compares 4 quantities:</p>
<ol style="list-style-type: decimal">
<li>Unit-Level Contrasts</li>
<li>Average Contrast</li>
<li>Contrast at the Mean</li>
<li>Contrast Between Marginal Means</li>
</ol>
<p>The ideas discussed in this section focus on contrasts, but they
carry over directly to analogous types of marginal effects.</p>
<div class="section level3">
<h3 id="unit-level-contrasts">Unit-level contrasts<a class="anchor" aria-label="anchor" href="#unit-level-contrasts"></a>
</h3>
<p>In models with interactions or non-linear components (e.g., link
function), the value of a contrast or marginal effect can depend on the
value of all the predictors in the model. As a result, contrasts and
marginal effects are fundamentally <em>unit-level</em> quantities. The
effect of a 1 unit increase in <span class="math inline">\(X\)</span>
can be different for Mary or John. Every row of a dataset has a
different contrast and marginal effect.</p>
<p>The <code>mtcars</code> dataset has 32 rows, so the
<code><a href="../reference/comparisons.html">comparisons()</a></code> function produces 32 contrast estimates:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">vs</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">gear</span><span class="op">)</span> <span class="op">+</span> <span class="va">mpg</span>, family <span class="op">=</span> <span class="va">binomial</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"mpg"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cmp</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 32</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="average-contrasts">Average contrasts<a class="anchor" aria-label="anchor" href="#average-contrasts"></a>
</h3>
<p>By default, the <code><a href="../reference/slopes.html">slopes()</a></code> and <code><a href="../reference/comparisons.html">comparisons()</a></code>
functions compute marginal effects and contrasts for every row of the
original dataset. These unit-level estimates can be of great interest,
as discussed in <a href="https://vincentarelbundock.github.io/marginaleffects/articles/logistic_comparisons.html">another
vignette</a>. Nevertheless, one may want to focus on one-number
summaries: the <code>avg_*()</code> functions or the <code>by</code>
argument compute the “Average Marginal Effect” or “Average Contrast,” by
taking the mean of all the unit-level estimates.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"mpg"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1  0.06081    0.01284 4.737 2.1714e-06 0.03565 0.08597</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"mpg"</span>, by <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1  0.06081    0.01284 4.737 2.1714e-06 0.03565 0.08597</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>which are equivalent to:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">cmp</span><span class="op">$</span><span class="va">estimate</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.06080995</span></span></code></pre></div>
<p>We could also show the full distribution of contrasts across our
dataset with a histogram:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">cmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"gear"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cmp</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span>bins <span class="op">=</span> <span class="fl">30</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">contrast</span>, scale <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Distribution of unit-level contrasts"</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparisons_files/figure-html/unnamed-chunk-20-1.png" width="576"></p>
<p>This graph display the effect of a change of 1 unit in the
<code>mpg</code> variable, for each individual in the observed data.</p>
</div>
<div class="section level3">
<h3 id="contrasts-at-the-mean">Contrasts at the mean<a class="anchor" aria-label="anchor" href="#contrasts-at-the-mean"></a>
</h3>
<p>An alternative which used to be very common but has now fallen into a
bit of disfavor is to compute “Contrasts at the mean.” The idea is to
create a “synthetic” or “hypothetical” individual (row of the dataset)
whose characteristics are completely average. Then, we compute and
report the contrast for this specific hypothetical individual.</p>
<p>This can be achieved by setting <code>newdata="mean"</code> or to
<code>newdata=datagrid()</code>, both of which fix variables to their
means or modes:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, variables <span class="op">=</span> <span class="st">"mpg"</span>, newdata <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error     z Pr(&gt;|z|)   2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1   0.1665    0.06246 2.666 0.007686 0.04407 0.2889</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: rowid, type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, vs, gear, mpg, eps</span></span></code></pre></div>
<p>Contrasts at the mean can differ substantially from average
contrasts.</p>
<p>The advantage of this approach is that it is very cheap and fast
computationally. The disadvantage is that the interpretation is somewhat
ambiguous. Often times, there simply does not exist an individual who is
perfectly average across all dimensions of the dataset. It is also not
clear why the analyst should be particularly interested in the contrast
for this one, synthetic, perfectly average individual.</p>
</div>
<div class="section level3">
<h3 id="contrasts-between-marginal-means">Contrasts between marginal means<a class="anchor" aria-label="anchor" href="#contrasts-between-marginal-means"></a>
</h3>
<p>Yet another type of contrast is the “Contrast between marginal
means.” This type of contrast is closely related to the “Contrast at the
mean”, with a few wrinkles. It is the default approach used by the
<code>emmeans</code> package for <code>R</code>.</p>
<p>Roughly speaking, the procedure is as follows:</p>
<ol style="list-style-type: decimal">
<li>Create a prediction grid with one cell for each combination of
categorical predictors in the model, and all numeric variables held at
their means.</li>
<li>Make adjusted predictions in each cell of the prediction grid.</li>
<li>Take the average of those predictions (marginal means) for each
combination of <code>btype</code> (focal variable) and <code>resp</code>
(group <code>by</code> variable).</li>
<li>Compute pairwise differences (contrasts) in marginal means across
different levels of the focal variable <code>btype</code>.</li>
</ol>
<p>The contrast obtained through this approach has two critical
characteristics:</p>
<ol style="list-style-type: lower-alpha">
<li>It is the contrast for a synthetic individual with perfectly average
qualities on every (numeric) predictor.</li>
<li>It is a weighted average of unit-level contrasts, where weights
assume a perfectly balanced dataset across every categorical
predictor.</li>
</ol>
<p>With respect to (a), the analyst should ask themselves: Is my
quantity of interest the contrast for a perfectly average hypothetical
individual? With respect to (b), the analyst should ask themselves: Is
my quantity of interest the contrast in a model estimated using
(potentially) unbalanced data, but interpreted <em>as if</em> the data
were perfectly balanced?</p>
<p>For example, imagine that one of the control variables in your model
is a variable measuring educational attainment in 4 categories: No high
school, High school, Some college, Completed college. The contrast
between marginal is a weighted average of contrasts estimated in the 4
cells, and each of those contrasts will be weighted equally in the
overall estimate. If the population of interest is highly unbalanced in
the educational categories, then the estimate computed in this way will
not be most useful.</p>
<p>If the contrasts between marginal means is really the quantity of
interest, it is easy to use the <code><a href="../reference/comparisons.html">comparisons()</a></code> to estimate
contrasts between marginal means. The <code>newdata</code> determines
the values of the predictors at which we want to compute contrasts. We
can set <code>newdata="marginalmeans"</code> to emulate the
<code>emmeans</code> behavior. For example, here we compute contrasts in
a model with an interaction:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/palmerpenguins/penguins.csv"</span><span class="op">)</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">bill_length_mm</span> <span class="op">~</span> <span class="va">species</span> <span class="op">*</span> <span class="va">sex</span> <span class="op">+</span> <span class="va">island</span> <span class="op">+</span> <span class="va">body_mass_g</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>    <span class="va">mod</span>,</span>
<span>    newdata <span class="op">=</span> <span class="st">"marginalmeans"</span>,</span>
<span>    variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"island"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term           Contrast Estimate Std. Error      z Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;  species Chinstrap - Adelie 10.26934     0.4067 25.252  &lt; 2e-16  9.4723 11.0664</span></span>
<span><span class="co">#&gt;  species    Gentoo - Adelie  5.89568     0.6773  8.705  &lt; 2e-16  4.5683  7.2231</span></span>
<span><span class="co">#&gt;   island     Dream - Biscoe -0.45571     0.4533 -1.005  0.31472 -1.3441  0.4327</span></span>
<span><span class="co">#&gt;   island Torgersen - Biscoe  0.08507     0.4701  0.181  0.85639 -0.8363  1.0064</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Which is equivalent to this in <code>emmeans</code>:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">emm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span></span>
<span>    <span class="va">mod</span>,</span>
<span>    specs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"species"</span>, <span class="st">"island"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/emmeans/man/contrast.html" class="external-link">contrast</a></span><span class="op">(</span><span class="va">emm</span>, method <span class="op">=</span> <span class="st">"trt.vs.ctrl1"</span><span class="op">)</span></span>
<span><span class="co">#&gt;  contrast                            estimate    SE  df t.ratio p.value</span></span>
<span><span class="co">#&gt;  Chinstrap Biscoe - Adelie Biscoe     10.2693 0.407 324  25.252  &lt;.0001</span></span>
<span><span class="co">#&gt;  Gentoo Biscoe - Adelie Biscoe         5.8957 0.677 324   8.705  &lt;.0001</span></span>
<span><span class="co">#&gt;  Adelie Dream - Adelie Biscoe         -0.4557 0.453 324  -1.005  0.8274</span></span>
<span><span class="co">#&gt;  Chinstrap Dream - Adelie Biscoe       9.8136 0.434 324  22.630  &lt;.0001</span></span>
<span><span class="co">#&gt;  Gentoo Dream - Adelie Biscoe          5.4400 0.941 324   5.779  &lt;.0001</span></span>
<span><span class="co">#&gt;  Adelie Torgersen - Adelie Biscoe      0.0851 0.470 324   0.181  0.9994</span></span>
<span><span class="co">#&gt;  Chinstrap Torgersen - Adelie Biscoe  10.3544 0.622 324  16.656  &lt;.0001</span></span>
<span><span class="co">#&gt;  Gentoo Torgersen - Adelie Biscoe      5.9808 0.954 324   6.268  &lt;.0001</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Results are averaged over the levels of: sex </span></span>
<span><span class="co">#&gt; P value adjustment: dunnettx method for 8 tests</span></span></code></pre></div>
<p>The <a href="https://vincentarelbundock.github.io/marginaleffects/articles/alternative_software.html#emmeans"><code>emmeans</code>
section of the Alternative Software vignette</a> shows further
examples.</p>
<p>The <a href="https://CRAN.R-project.org/package=emmeans/vignettes/basics.html" class="external-link">excellent
vignette of the <code>emmeans</code> package</a> discuss the same issues
in a slightly different (and more positive) way:</p>
<blockquote>
<p>The point is that the marginal means of cell.means give equal weight
to each cell. In many situations (especially with experimental data),
that is a much fairer way to compute marginal means, in that they are
not biased by imbalances in the data. We are, in a sense, estimating
what the marginal means would be, had the experiment been balanced.
Estimated marginal means (EMMs) serve that need.</p>
</blockquote>
<blockquote>
<p>All this said, there are certainly situations where equal weighting
is not appropriate. Suppose, for example, we have data on sales of a
product given different packaging and features. The data could be
unbalanced because customers are more attracted to some combinations
than others. If our goal is to understand scientifically what packaging
and features are inherently more profitable, then equally weighted EMMs
may be appropriate; but if our goal is to predict or maximize profit,
the ordinary marginal means provide better estimates of what we can
expect in the marketplace.</p>
</blockquote>
</div>
</div>
<div class="section level2">
<h2 id="conditional-contrasts">Conditional contrasts<a class="anchor" aria-label="anchor" href="#conditional-contrasts"></a>
</h2>
<p>Consider a model with an interaction term. What happens to the
dependent variable when the <code>hp</code> variable increases by 10
units?</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="va">hp</span> <span class="op">*</span> <span class="va">wt</span>, data <span class="op">=</span> <span class="va">mtcars</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_comparisons.html">plot_comparisons</a></span><span class="op">(</span></span>
<span>    <span class="va">mod</span>,</span>
<span>    effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hp <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    condition <span class="op">=</span> <span class="st">"wt"</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparisons_files/figure-html/unnamed-chunk-24-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="transformations">Transformations<a class="anchor" aria-label="anchor" href="#transformations"></a>
</h2>
<p>So far we have focused on simple differences between adjusted
predictions. Now, we show how to use ratios, back transformations, and
arbitrary functions to estimate a slew of quantities of interest.
Powerful transformations and custom contrasts are made possible by using
three arguments which act at different stages of the computation
process:</p>
<ul>
<li><code>transform_pre</code></li>
<li><code>transform_post</code></li>
</ul>
<p>Consider the case of a model with a single predictor <span class="math inline">\(x\)</span>. To compute average contrasts, we
proceed as follows:</p>
<ol style="list-style-type: decimal">
<li>Compute adjusted predictions for each row of the dataset for the
observed values <span class="math inline">\(x\)</span>: <span class="math inline">\(\hat{y}_x\)</span>
</li>
<li>Compute adjusted predictions for each row of the dataset for the
observed values <span class="math inline">\(x + 1\)</span>: <span class="math inline">\(\hat{y}_{x+1}\)</span>
</li>
<li>
<code>transform_pre</code>: Compute unit-level contrasts by taking
the difference between (or some other function of) adjusted predictions:
<span class="math inline">\(\hat{y}_{x+1} - \hat{y}_x\)</span>
</li>
<li>Compute the average contrast by taking the mean of unit-level
contrasts: <span class="math inline">\(1/N \sum_{i=1}^N \hat{y}_{x+1} -
\hat{y}_x\)</span>
</li>
<li>
<code>transform_post</code>: Transform the average contrast or
return them as-is.</li>
</ol>
<p>The <code>transform_pre</code> argument of the
<code><a href="../reference/comparisons.html">comparisons()</a></code> function determines how adjusted predictions
are combined to create a contrast. By default, we take a simple
difference between predictions with <code>hi</code> value of <span class="math inline">\(x\)</span>, and predictions with a <code>lo</code>
value of <span class="math inline">\(x\)</span>:
<code>function(hi, lo) hi-lo</code>.</p>
<p>The <code>transform_post</code> argument of the
<code><a href="../reference/comparisons.html">comparisons()</a></code> function applies a custom transformation to
the unit-level contrasts.</p>
<p>The <code>transform_post</code> argument applies a custom
transformation to the final quantity, as would be returned if we
evaluated the same call without <code>transform_post</code>.</p>
</div>
<div class="section level2">
<h2 id="differences">Differences<a class="anchor" aria-label="anchor" href="#differences"></a>
</h2>
<p>The default contrast calculate by the <code><a href="../reference/comparisons.html">comparisons()</a></code>
function is a (untransformed) difference between two adjusted
predictions. For instance, to estimate the effect of a change of 1 unit,
we do:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">vs</span> <span class="op">~</span> <span class="va">mpg</span>, data <span class="op">=</span> <span class="va">mtcars</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># construct data</span></span>
<span></span>
<span><span class="va">mtcars_minus</span> <span class="op">&lt;-</span> <span class="va">mtcars_plus</span> <span class="op">&lt;-</span> <span class="va">mtcars</span></span>
<span><span class="va">mtcars_minus</span><span class="op">$</span><span class="va">mpg</span> <span class="op">&lt;-</span> <span class="va">mtcars_minus</span><span class="op">$</span><span class="va">mpg</span> <span class="op">-</span> <span class="fl">0.5</span></span>
<span><span class="va">mtcars_plus</span><span class="op">$</span><span class="va">mpg</span> <span class="op">&lt;-</span> <span class="va">mtcars_plus</span><span class="op">$</span><span class="va">mpg</span> <span class="op">+</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="co"># adjusted predictions</span></span>
<span><span class="va">yhat_minus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">mtcars_minus</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span><span class="va">yhat_plus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">mod</span>, newdata <span class="op">=</span> <span class="va">mtcars_plus</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># unit-level contrasts</span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="va">yhat_plus</span> <span class="op">-</span> <span class="va">yhat_minus</span></span>
<span></span>
<span><span class="co"># average contrasts</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.05540227</span></span></code></pre></div>
<p>We can use the <code><a href="../reference/comparisons.html">avg_comparisons()</a></code> function , or the
<code>by</code> argument to obtain the same results:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1   0.0554   0.008327 6.653 2.8699e-11 0.03908 0.07172</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span><span class="va">mod</span>, by <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|)   2.5 %  97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1   0.0554   0.008327 6.653 2.8699e-11 0.03908 0.07172</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="difference-in-differences-in-differences">Difference-in-Differences(-in-Differences)<a class="anchor" aria-label="anchor" href="#difference-in-differences-in-differences"></a>
</h2>
<p>Going back to our Titanic example:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/Stat2Data/Titanic.csv"</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">dat</span><span class="op">)</span></span>
<span><span class="va">titanic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Survived</span> <span class="op">~</span> <span class="va">PClass</span> <span class="op">*</span> <span class="va">SexCode</span> <span class="op">*</span> <span class="va">Age</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></code></pre></div>
<p>In this case, a contrast is a difference between predicted
probabilities. We can compute that contrast for different types of
individuals:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">titanic</span>,</span>
<span>  variables <span class="op">=</span> <span class="st">"SexCode"</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>PClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1st"</span>, <span class="st">"3rd"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term Contrast Estimate Std. Error     z   Pr(&gt;|z|)  2.5 % 97.5 % PClass</span></span>
<span><span class="co">#&gt;  SexCode    1 - 0   0.4828    0.06308 7.653 1.9593e-14 0.3591 0.6064    1st</span></span>
<span><span class="co">#&gt;  SexCode    1 - 0   0.3351    0.06343 5.283 1.2703e-07 0.2108 0.4594    3rd</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: rowid, type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, Survived, SexCode, Age, PClass, eps</span></span></code></pre></div>
<p>One we can notice above, is that the gap in predicted probabilities
of survival between men and women is larger in 1st class than in 3rd
class. Being a woman matters more for your chances of survival if you
travel in first class. Is the difference between those contrasts
(diff-in-diff) statistically significant?</p>
<p>To answer this question, we can compute a difference-in-difference
using the <code>hypothesis</code> argument (<a href="https://vincentarelbundock.github.io/marginaleffects/articles/hypothesis.html">see
the Hypothesis vignette for details</a>). For example, using
<code>b1</code> and <code>b2</code> to refer to the contrasts in the
first and second rows of the output above, we can test if the difference
between the two quantities is different from 0:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">titanic</span>,</span>
<span>  hypothesis <span class="op">=</span> <span class="st">"b1 - b2 = 0"</span>,</span>
<span>  variables <span class="op">=</span> <span class="st">"SexCode"</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>PClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1st"</span>, <span class="st">"3rd"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term Estimate Std. Error     z Pr(&gt;|z|)    2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  b1-b2=0   0.1477    0.08945 1.651 0.098742 -0.02764  0.323</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Now, let’s say we consider more types of individuals:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">titanic</span>,</span>
<span>  variables <span class="op">=</span> <span class="st">"SexCode"</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>PClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1st"</span>, <span class="st">"3rd"</span><span class="op">)</span>, Age <span class="op">=</span> <span class="va">range</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term Contrast Estimate Std. Error       z Pr(&gt;|z|)    2.5 % 97.5 % PClass   Age</span></span>
<span><span class="co">#&gt;  SexCode    1 - 0  0.10807     0.1224  0.8827 0.377423 -0.13190 0.3480    1st  0.17</span></span>
<span><span class="co">#&gt;  SexCode    1 - 0  0.87952     0.0570 15.4293  &lt; 2e-16  0.76780 0.9912    1st 71.00</span></span>
<span><span class="co">#&gt;  SexCode    1 - 0  0.08049     0.1570  0.5127 0.608149 -0.22721 0.3882    3rd  0.17</span></span>
<span><span class="co">#&gt;  SexCode    1 - 0  0.42648     0.2031  2.1002 0.035714  0.02847 0.8245    3rd 71.00</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: rowid, type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo, Survived, SexCode, PClass, Age, eps</span></span></code></pre></div>
<p>With these results, we could compute a triple difference:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">titanic</span>,</span>
<span>  hypothesis <span class="op">=</span> <span class="st">"(b1 - b3) - (b2 - b4) = 0"</span>,</span>
<span>  variables <span class="op">=</span> <span class="st">"SexCode"</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>PClass <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"1st"</span>, <span class="st">"3rd"</span><span class="op">)</span>, Age <span class="op">=</span> <span class="va">range</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;               Term Estimate Std. Error      z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  (b1-b3)-(b2-b4)=0  -0.4255     0.3589 -1.185  0.23585 -1.129  0.278</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="ratios">Ratios<a class="anchor" aria-label="anchor" href="#ratios"></a>
</h2>
<p>Instead of taking simple differences between adjusted predictions, it
can sometimes be useful to compute ratios or other functions of
predictions. For example, <a href="https://journals.sagepub.com/doi/pdf/10.1177/1536867X1301300304" class="external-link">the
<code>adjrr</code> function the <code>Stata</code> software package</a>
can compute “adjusted risk ratios”, which are ratios of adjusted
predictions. To do this in <code>R</code>, we use the
<code>transform_pre</code> argument:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, transform_pre <span class="op">=</span> <span class="st">"ratio"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1    1.287     0.1328 9.697 &lt; 2.22e-16 1.027  1.548</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>This result is the average adjusted risk ratio, that is, the adjusted
predictions when the <code>mpg</code> are incremented by 1, divided by
the adjusted predictions when <code>mpg</code> is at its original
value.</p>
<p>The <code>transform_pre</code> accepts different values for common
types of contrasts: ‘difference’, ‘ratio’, ‘lnratio’, ‘ratioavg’,
‘lnratioavg’, ‘lnoravg’, ‘differenceavg’. These strings are shortcuts
for functions that accept two vectors of adjusted predictions and
returns a single vector of contrasts. For example, these two commands
yield identical results:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, transform_pre <span class="op">=</span> <span class="st">"ratio"</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1    1.287     0.1328 9.697 &lt; 2.22e-16 1.027  1.548</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, transform_pre <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">hi</span>, <span class="va">lo</span><span class="op">)</span> <span class="va">hi</span> <span class="op">/</span> <span class="va">lo</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error     z   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1    1.287     0.1328 9.697 &lt; 2.22e-16 1.027  1.548</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Pre-transformation:  transform_pre </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>This mechanism is powerful, because it lets users create fully
customized contrasts. Here is a non-sensical example:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod</span>, transform_pre <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">hi</span>, <span class="va">lo</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">hi</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">lo</span> <span class="op">+</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate Std. Error    z   Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1   0.2641    0.02614 10.1 &lt; 2.22e-16 0.2128 0.3153</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Pre-transformation:  transform_pre </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>The same arguments work in the plotting function
<code><a href="../reference/plot_comparisons.html">plot_comparisons()</a></code> as well, which allows us to plot various
custom contrasts. Here is a comparison of Adjusted Risk Ratio and
Adjusted Risk Difference in a model of the probability of survival
aboard the Titanic:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="va">titanic</span> <span class="op">&lt;-</span> <span class="st">"https://vincentarelbundock.github.io/Rdatasets/csv/Stat2Data/Titanic.csv"</span></span>
<span><span class="va">titanic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="va">titanic</span><span class="op">)</span></span>
<span><span class="va">mod_titanic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span></span>
<span>    <span class="va">Survived</span> <span class="op">~</span> <span class="va">Sex</span> <span class="op">*</span> <span class="va">PClass</span> <span class="op">+</span> <span class="va">Age</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I</a></span><span class="op">(</span><span class="va">Age</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>    family <span class="op">=</span> <span class="va">binomial</span>,</span>
<span>    data <span class="op">=</span> <span class="va">titanic</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span><span class="va">mod_titanic</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    Term      Contrast  Estimate Std. Error       z   Pr(&gt;|z|)     2.5 %    97.5 %</span></span>
<span><span class="co">#&gt;     Sex male - female -0.484676   0.030607 -15.835 &lt; 2.22e-16 -0.544665 -0.424687</span></span>
<span><span class="co">#&gt;  PClass     2nd - 1st -0.205782   0.039374  -5.226 1.7296e-07 -0.282954 -0.128609</span></span>
<span><span class="co">#&gt;  PClass     3rd - 1st -0.404283   0.039839 -10.148 &lt; 2.22e-16 -0.482367 -0.326199</span></span>
<span><span class="co">#&gt;     Age            +1 -0.006504   0.001072  -6.069 1.2904e-09 -0.008605 -0.004403</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_comparisons.html">plot_comparisons</a></span><span class="op">(</span></span>
<span>    <span class="va">mod_titanic</span>,</span>
<span>    effect <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>    condition <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>    transform_pre <span class="op">=</span> <span class="st">"ratio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Adjusted Risk Ratio\nP(Survival | Age + 1) / P(Survival | Age)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/plot_comparisons.html">plot_comparisons</a></span><span class="op">(</span></span>
<span>    <span class="va">mod_titanic</span>,</span>
<span>    effect <span class="op">=</span> <span class="st">"Age"</span>,</span>
<span>    condition <span class="op">=</span> <span class="st">"Age"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Adjusted Risk Difference\nP(Survival | Age + 1) - P(Survival | Age)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span></span></code></pre></div>
<p><img src="comparisons_files/figure-html/unnamed-chunk-35-1.png" width="576"></p>
<p>By default, the standard errors around contrasts are computed using
the delta method on the scale determined by the <code>type</code>
argument (e.g., “link” or “response”). Some analysts may prefer to
proceed differently. For example, in <code>Stata</code>, the
<code>adjrr</code> computes adjusted risk ratios (ARR) in two steps:</p>
<ol style="list-style-type: decimal">
<li>Compute the natural log of the ratio between the mean of adjusted
predictions with <span class="math inline">\(x+1\)</span> and the mean
of adjusted predictions with <span class="math inline">\(x\)</span>.</li>
<li>Exponentiate the estimate and confidence interval bounds.</li>
</ol>
<p>Step 1 is easy to achieve with the <code>transform_pre</code>
argument described above. Step 2 can be achieved with the
<code>transform_post</code> argument:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>    <span class="va">mod</span>,</span>
<span>    transform_pre <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">hi</span>, <span class="va">lo</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">hi</span> <span class="op">/</span> <span class="va">lo</span><span class="op">)</span>,</span>
<span>    transform_post <span class="op">=</span> <span class="va">exp</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate  Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   mpg       +1    1.274 0.0093462 1.061  1.529</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Pre-transformation:  transform_pre </span></span>
<span><span class="co">#&gt; Post-transformation:  transform_post </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Note that equivalent results can be obtained using shortcut strings
in the <code>transform_pre</code> argument: “ratio”, “lnratio”,
“lnratioavg”.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>    <span class="va">mod</span>,</span>
<span>    transform_pre <span class="op">=</span> <span class="st">"lnratioavg"</span>,</span>
<span>    transform_post <span class="op">=</span> <span class="va">exp</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Term Contrast Estimate   Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;   mpg mean(+1)    1.135 2.3808e-10 1.091   1.18</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Post-transformation:  exp </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, p.value, conf.low, conf.high, predicted, predicted_hi, predicted_lo</span></span></code></pre></div>
<p>All the same arguments apply to the plotting functions of the
<code>marginaleffects</code> package as well. For example we can plot
the Adjusted Risk Ratio in a model with a quadratic term:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">vs</span> <span class="op">~</span> <span class="va">mpg</span> <span class="op">+</span> <span class="va">mpg</span><span class="op">^</span><span class="fl">2</span>, data <span class="op">=</span> <span class="va">mtcars</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/plot_comparisons.html">plot_comparisons</a></span><span class="op">(</span></span>
<span>    <span class="va">mod2</span>,</span>
<span>    effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"mpg"</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>    condition <span class="op">=</span> <span class="st">"mpg"</span>,</span>
<span>    transformation_pre <span class="op">=</span> <span class="st">"ratio"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Adjusted Risk Ratio\nP(vs = 1 | mpg + 10) / P(vs = 1 | mpg)"</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparisons_files/figure-html/unnamed-chunk-39-1.png" width="576"></p>
</div>
<div class="section level2">
<h2 id="forward-backward-centered-and-custom-differences">Forward, Backward, Centered, and Custom Differences<a class="anchor" aria-label="anchor" href="#forward-backward-centered-and-custom-differences"></a>
</h2>
<p>By default, the <code><a href="../reference/comparisons.html">comparisons()</a></code> function computes a
“centered” difference. For example, if we ask <code><a href="../reference/comparisons.html">comparisons()</a></code>
to estimate the effect of a 10-unit change in predictor <code>x</code>
on outcome <code>y</code>, <code><a href="../reference/comparisons.html">comparisons()</a></code> will compare the
predicted values with <code>x-5</code> and <code>x+5</code>.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mtcars</span></span>
<span><span class="va">dat</span><span class="op">$</span><span class="va">new_hp</span> <span class="op">&lt;-</span> <span class="fl">49</span> <span class="op">*</span> <span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">hp</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">hp</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">hp</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">$</span><span class="va">hp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">mpg</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">new_hp</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">dat</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>new_hp <span class="op">=</span> <span class="fl">10</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    Term Contrast Estimate Std. Error      z   Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  new_hp      +10   -4.056      0.464 -8.742 &lt; 2.22e-16 -4.966 -3.147</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Since version 0.7.2 of <code>marginaleffects</code>, we can supply
arbitrary functions to create custom differences. These functions must
accept a vector of values for the predictor of interest, and return a
data frame with the same number of rows as the length, and two columns
with the values to compare. For example, we can do:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forward_diff</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">x</span> <span class="op">+</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">backward_diff</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">10</span>, <span class="va">x</span><span class="op">)</span></span>
<span><span class="va">center_diff</span> <span class="op">&lt;-</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="fl">5</span>, <span class="va">x</span> <span class="op">+</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>new_hp <span class="op">=</span> <span class="va">forward_diff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    Term Contrast Estimate Std. Error      z   Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  new_hp   custom   -3.799     0.4346 -8.742 &lt; 2.22e-16 -4.651 -2.948</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>new_hp <span class="op">=</span> <span class="va">backward_diff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    Term Contrast Estimate Std. Error      z   Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  new_hp   custom   -6.507     0.7443 -8.742 &lt; 2.22e-16 -7.966 -5.048</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">avg_comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>new_hp <span class="op">=</span> <span class="va">center_diff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;    Term Contrast Estimate Std. Error      z   Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">#&gt;  new_hp   custom   -4.056      0.464 -8.742 &lt; 2.22e-16 -4.966 -3.147</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: type, term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre></div>
<p>Notice that the last “centered” difference gives the same results as
the default <code><a href="../reference/comparisons.html">comparisons()</a></code> call.</p>
</div>
<div class="section level2">
<h2 id="lognormal-hurdle-model">Lognormal hurdle model<a class="anchor" aria-label="anchor" href="#lognormal-hurdle-model"></a>
</h2>
<p>With hurdle models, we can fit two separate models
simultaneously:</p>
<ol style="list-style-type: decimal">
<li>A model that predicts if the outcome is zero or not zero</li>
<li>If the outcome is not zero, a model that predicts what the value of
the outcome is</li>
</ol>
<p>We can calculate predictions and marginal effects for each of these
hurdle model processes, but doing so requires some variable
transformation since the stages of these models use different link
functions.</p>
<p>The <code><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html" class="external-link">hurdle_lognormal()</a></code> family in <code>brms</code> uses
logistic regression (with a logit link) for the hurdle part of the model
and lognormal regression (where the outcome is logged before getting
used in the model) for the non-hurdled part. Let’s look at an example of
predicting GDP per capita (which is distributed exponentially) using
life expectancy. We’ll add some artificial zeros so that we can work
with a hurdle stage of the model.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://vincentarelbundock.github.io/marginaleffects/">marginaleffects</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder" class="external-link">gapminder</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Build some 0s into the GDP column</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span><span class="va">gapminder</span> <span class="op">&lt;-</span> <span class="fu">gapminder</span><span class="fu">::</span><span class="va">gapminder</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">continent</span> <span class="op">!=</span> <span class="st">"Oceania"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Make a bunch of GDP values 0</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>prob_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">lifeExp</span> <span class="op">&lt;</span> <span class="fl">50</span>, <span class="fl">0.3</span>, <span class="fl">0.02</span><span class="op">)</span>,</span>
<span>         will_be_zero <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">prob_zero</span><span class="op">)</span>,</span>
<span>         gdpPercap0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">will_be_zero</span>, <span class="fl">0</span>, <span class="va">gdpPercap</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">prob_zero</span>, <span class="op">-</span><span class="va">will_be_zero</span><span class="op">)</span></span>
<span></span>
<span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span><span class="va">gdpPercap0</span> <span class="op">~</span> <span class="va">lifeExp</span>,</span>
<span>     <span class="va">hu</span> <span class="op">~</span> <span class="va">lifeExp</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/brms/man/brmsfamily.html" class="external-link">hurdle_lognormal</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, cores <span class="op">=</span> <span class="fl">4</span>, seed <span class="op">=</span> <span class="fl">1234</span><span class="op">)</span></span></code></pre></div>
<p>We have two different sets of coefficients here for the two different
processes. The hurdle part (<code>hu</code>) uses a logit link, and the
non-hurdle part (<code>mu</code>) uses an identity link. However, that’s
a slight misnomer—a true identity link would show the coefficients on a
non-logged dollar value scale. Because we’re using a
<code>lognormal</code> family, GDP per capita is pre-logged, so the
“original” identity scale is actually logged dollars.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">#&gt;  Family: hurdle_lognormal </span></span>
<span><span class="co">#&gt;   Links: mu = identity; sigma = identity; hu = logit </span></span>
<span><span class="co">#&gt; Formula: gdpPercap0 ~ lifeExp </span></span>
<span><span class="co">#&gt;          hu ~ lifeExp</span></span>
<span><span class="co">#&gt;    Data: gapminder (Number of observations: 1680) </span></span>
<span><span class="co">#&gt;   Draws: 4 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 4000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;              Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept        3.47      0.09     3.29     3.65 1.00     4757     3378</span></span>
<span><span class="co">#&gt; hu_Intercept     3.16      0.40     2.37     3.96 1.00     2773     2679</span></span>
<span><span class="co">#&gt; lifeExp          0.08      0.00     0.08     0.08 1.00     5112     3202</span></span>
<span><span class="co">#&gt; hu_lifeExp      -0.10      0.01    -0.12    -0.08 1.00     2385     2652</span></span>
<span><span class="co">#&gt; ...</span></span></code></pre>
<p>We can get predictions for the <code>hu</code> part of the model on
the link (logit) scale:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>, type <span class="op">=</span> <span class="st">"link"</span>,</span>
<span>            newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate 2.5 % 97.5 % lifeExp</span></span>
<span><span class="co">#&gt;    -0.817 -1.03 -0.604      40</span></span>
<span><span class="co">#&gt;    -2.805 -3.06 -2.555      60</span></span>
<span><span class="co">#&gt;    -4.790 -5.34 -4.275      80</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  link </span></span>
<span><span class="co">#&gt; Columns: rowid, type, estimate, conf.low, conf.high, gdpPercap0, lifeExp</span></span></code></pre></div>
<p>…or on the response (percentage point) scale:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>            newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate   2.5 % 97.5 % lifeExp</span></span>
<span><span class="co">#&gt;   0.30630 0.26231 0.3534      40</span></span>
<span><span class="co">#&gt;   0.05703 0.04466 0.0721      60</span></span>
<span><span class="co">#&gt;   0.00824 0.00478 0.0137      80</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: rowid, type, estimate, conf.low, conf.high, gdpPercap0, lifeExp</span></span></code></pre></div>
<p>We can also get slopes for the <code>hu</code> part of the model on
the link (logit) or response (percentage point) scales:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/slopes.html">slopes</a></span><span class="op">(</span><span class="va">mod</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>, type <span class="op">=</span> <span class="st">"link"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term Estimate  2.5 %  97.5 % lifeExp</span></span>
<span><span class="co">#&gt;  lifeExp  -0.0993 -0.116 -0.0837      40</span></span>
<span><span class="co">#&gt;  lifeExp  -0.0993 -0.116 -0.0837      60</span></span>
<span><span class="co">#&gt;  lifeExp  -0.0993 -0.116 -0.0837      80</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  link </span></span>
<span><span class="co">#&gt; Columns: rowid, type, term, estimate, conf.low, conf.high, predicted, predicted_hi, predicted_lo, gdpPercap0, lifeExp, eps</span></span>
<span></span>
<span><span class="fu"><a href="../reference/slopes.html">slopes</a></span><span class="op">(</span><span class="va">mod</span>, dpar <span class="op">=</span> <span class="st">"hu"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term  Estimate    2.5 %    97.5 % lifeExp</span></span>
<span><span class="co">#&gt;  lifeExp -0.021078 -0.02591 -0.016588      40</span></span>
<span><span class="co">#&gt;  lifeExp -0.005321 -0.00615 -0.004561      60</span></span>
<span><span class="co">#&gt;  lifeExp -0.000812 -0.00115 -0.000543      80</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: rowid, type, term, estimate, conf.low, conf.high, predicted, predicted_hi, predicted_lo, gdpPercap0, lifeExp, eps</span></span></code></pre></div>
<p>Working with the <code>mu</code> part of the model is trickier.
Switching between <code>type = "link"</code> and
<code>type = "response"</code> doesn’t change anything, since the
outcome is pre-logged:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>, type <span class="op">=</span> <span class="st">"link"</span>,</span>
<span>            newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate 2.5 % 97.5 % lifeExp</span></span>
<span><span class="co">#&gt;      6.61  6.54   6.69      40</span></span>
<span><span class="co">#&gt;      8.18  8.15   8.22      60</span></span>
<span><span class="co">#&gt;      9.75  9.69   9.82      80</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  link </span></span>
<span><span class="co">#&gt; Columns: rowid, type, estimate, conf.low, conf.high, gdpPercap0, lifeExp</span></span>
<span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>, type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>            newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate 2.5 % 97.5 % lifeExp</span></span>
<span><span class="co">#&gt;      6.61  6.54   6.69      40</span></span>
<span><span class="co">#&gt;      8.18  8.15   8.22      60</span></span>
<span><span class="co">#&gt;      9.75  9.69   9.82      80</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Columns: rowid, type, estimate, conf.low, conf.high, gdpPercap0, lifeExp</span></span></code></pre></div>
<p>For <strong>predictions</strong>, we need to exponentiate the results
to scale them back up to dollar amounts. We can do this by
post-processing the results (e.g. with
<code>dplyr::mutate(predicted = exp(predicted))</code>), or we can use
the <code>transform_post</code> argument in <code><a href="../reference/predictions.html">predictions()</a></code>
to pass the results to <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp()</a></code> after getting calculated:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span><span class="va">mod</span>, dpar <span class="op">=</span> <span class="st">"mu"</span>, </span>
<span>            newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            transform_post <span class="op">=</span> <span class="va">exp</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  Estimate 2.5 % 97.5 % lifeExp</span></span>
<span><span class="co">#&gt;       744   694    801      40</span></span>
<span><span class="co">#&gt;      3581  3449   3718      60</span></span>
<span><span class="co">#&gt;     17215 16110  18410      80</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Post-transformation:  transform_post </span></span>
<span><span class="co">#&gt; Columns: rowid, type, estimate, conf.low, conf.high, gdpPercap0, lifeExp</span></span></code></pre></div>
<p>We can pass <code>transform_post = exp</code> to
<code><a href="../reference/plot_predictions.html">plot_predictions()</a></code> too:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_predictions.html">plot_predictions</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  dpar <span class="op">=</span> <span class="st">"hu"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"link"</span>,</span>
<span>  condition <span class="op">=</span> <span class="st">"lifeExp"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"hu"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Hurdle part (hu)"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Logit-scale predictions"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="../reference/plot_predictions.html">plot_predictions</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  dpar <span class="op">=</span> <span class="st">"hu"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"response"</span>,</span>
<span>  condition <span class="op">=</span> <span class="st">"lifeExp"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"hu"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Percentage point-scale predictions"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="../reference/plot_predictions.html">plot_predictions</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>  condition <span class="op">=</span> <span class="st">"lifeExp"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>       title <span class="op">=</span> <span class="st">"Non-hurdle part (mu)"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Log-scale predictions"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="../reference/plot_predictions.html">plot_predictions</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>  transform_post <span class="op">=</span> <span class="va">exp</span>,</span>
<span>  condition <span class="op">=</span> <span class="st">"lifeExp"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Dollar-scale predictions"</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparisons_files/figure-html/plot-hurdle-parts-1.png" width="768"></p>
<p>For <strong>marginal effects</strong>, we need to transform the
predictions <em>before</em> calculating the instantaneous slopes. We
also can’t use the <code><a href="../reference/slopes.html">slopes()</a></code> function directly—we need to
use <code><a href="../reference/comparisons.html">comparisons()</a></code> and compute the numerical derivative
ourselves (i.e. predict <code>gdpPercap</code> at <code>lifeExp</code>
of 40 and 40.001 and calculate the slope between those predictions). We
can use the <code>transform_pre</code> argument to pass the pair of
predicted values to <code><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp()</a></code> before calculating the
slopes:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># step size of the numerical derivative</span></span>
<span><span class="va">eps</span> <span class="op">&lt;-</span> <span class="fl">0.001</span></span>
<span></span>
<span><span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="va">eps</span><span class="op">)</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="co"># rescale the elements of the slope</span></span>
<span>  <span class="co"># (exp(40.001) - exp(40)) / exp(0.001)</span></span>
<span>  transform_pre <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">hi</span>, <span class="va">lo</span><span class="op">)</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">hi</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">lo</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eps</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">eps</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     Term Contrast Estimate  2.5 % 97.5 % lifeExp</span></span>
<span><span class="co">#&gt;  lifeExp   +0.001     58.4   55.8     61      40</span></span>
<span><span class="co">#&gt;  lifeExp   +0.001    280.9  266.6    296      60</span></span>
<span><span class="co">#&gt;  lifeExp   +0.001   1349.4 1222.6   1490      80</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Prediction type:  response </span></span>
<span><span class="co">#&gt; Pre-transformation:  function(hi, lo) ((exp(hi) - exp(lo))/exp(eps))/eps </span></span>
<span><span class="co">#&gt; Columns: rowid, type, term, contrast, estimate, conf.low, conf.high, predicted, predicted_hi, predicted_lo, gdpPercap0, lifeExp, eps</span></span></code></pre></div>
<p>We can visually confirm that these are the instantaneous slopes at
each of these levels of life expectancy:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">predictions_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/predictions.html">predictions</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">80</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>  transform_post <span class="op">=</span> <span class="va">exp</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">lifeExp</span>, prediction <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slopes_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/comparisons.html">comparisons</a></span><span class="op">(</span></span>
<span>  <span class="va">mod</span>,</span>
<span>  dpar <span class="op">=</span> <span class="st">"mu"</span>,</span>
<span>  variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="va">eps</span><span class="op">)</span>,</span>
<span>  newdata <span class="op">=</span> <span class="fu"><a href="../reference/datagrid.html">datagrid</a></span><span class="op">(</span>lifeExp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">40</span>, <span class="fl">80</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  transform_pre <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">hi</span>, <span class="va">lo</span><span class="op">)</span> <span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">hi</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">lo</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">eps</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">eps</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">lifeExp</span>, <span class="va">estimate</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">predictions_data</span>, by <span class="op">=</span> <span class="st">"lifeExp"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Point-slope formula: (y - y1) = m(x - x1)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>intercept <span class="op">=</span> <span class="va">estimate</span> <span class="op">*</span> <span class="op">(</span><span class="op">-</span><span class="va">lifeExp</span><span class="op">)</span> <span class="op">+</span> <span class="va">prediction</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">predictions_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">lifeExp</span>, y <span class="op">=</span> <span class="va">prediction</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">slopes_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>slope <span class="op">=</span> <span class="va">estimate</span>, intercept <span class="op">=</span> <span class="va">intercept</span><span class="op">)</span>, </span>
<span>              size <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">slopes_data</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_label</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">slopes_data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Slope: "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">estimate</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             nudge_x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>, hjust <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="comparisons_files/figure-html/hurdle-dollar-slopes-1.png" width="672"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Vincent Arel-Bundock.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
